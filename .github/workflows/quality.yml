name: Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run quality checks weekly
    - cron: '0 0 * * 1'

jobs:
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check for unsafe code
      run: |
        # Count unsafe blocks/functions
        unsafe_count=$(cargo +nightly rustc -- -Z unstable-options --pretty=expanded src/main.rs 2>/dev/null | grep -c "unsafe" || echo "0")
        if [ "$unsafe_count" -gt 0 ]; then
          echo "Found $unsafe_count unsafe blocks in the codebase"
          exit 1
        else
          echo "‚úÖ No unsafe code blocks found"
        fi

    - name: Check documentation
      run: cargo doc --no-deps --document-private-items

    - name: Run all tests with coverage info
      run: cargo test --verbose -- --nocapture

    - name: Check minimum Rust version compatibility
      run: |
        # Test with MSRV (minimum supported Rust version)
        rustup install 1.70.0
        rustup target add x86_64-unknown-linux-gnu --toolchain 1.70.0
        cargo +1.70.0 check

    - name: Verify workspace structure
      run: |
        # Check that all expected binaries exist
        cargo build --release --bin rdnsx
        ls -la target/release/rdnsx
        ./target/release/rdnsx --version

    - name: Performance regression check
      run: |
        echo "üèÉ Running performance tests..."

        # Basic performance sanity check
        START_TIME=$(date +%s)
        timeout 30s ./target/release/rdnsx query example.com --a --silent --timeout 5 || echo "Query timed out (expected for CI)"
        END_TIME=$(date +%s)

        QUERY_TIME=$((END_TIME - START_TIME))
        echo "Query execution time: ${QUERY_TIME}s"

        # Check binary size
        BINARY_SIZE=$(stat -c%s target/release/rdnsx 2>/dev/null || stat -f%z target/release/rdnsx 2>/dev/null || echo "0")
        BINARY_SIZE_MB=$((BINARY_SIZE / 1024 / 1024))

        echo "Binary size: ${BINARY_SIZE_MB}MB"

        # Performance thresholds
        if [ "$BINARY_SIZE_MB" -gt 50 ]; then
          echo "‚ö†Ô∏è  Warning: Binary size (${BINARY_SIZE_MB}MB) exceeds recommended limit (50MB)"
        else
          echo "‚úÖ Binary size within acceptable limits"
        fi

        if [ "$QUERY_TIME" -gt 10 ]; then
          echo "‚ö†Ô∏è  Warning: Query time (${QUERY_TIME}s) is slower than expected"
        else
          echo "‚úÖ Query performance within acceptable limits"
        fi

    - name: Generate build metrics
      run: |
        echo "üìä Build Metrics Report"
        echo "======================="

        # Cargo build timing (approximate)
        echo "Build completed successfully"

        # Test coverage estimate
        TEST_COUNT=$(cargo test 2>&1 | grep -c "test result" || echo "0")
        echo "Test suites executed: $TEST_COUNT"

        # Dependency count
        DEP_COUNT=$(cargo tree 2>/dev/null | grep -c "‚îú‚îÄ‚îÄ" || echo "0")
        echo "Total dependencies: $DEP_COUNT"

        echo "‚úÖ Quality checks completed"

    - name: Check binary size
      run: |
        # Ensure binary size is reasonable
        BINARY_SIZE=$(stat -c%s target/release/rdnsx)
        MAX_SIZE=50000000  # 50MB max
        if [ "$BINARY_SIZE" -gt "$MAX_SIZE" ]; then
          echo "‚ùå Binary size ($BINARY_SIZE bytes) exceeds maximum ($MAX_SIZE bytes)"
          exit 1
        else
          echo "‚úÖ Binary size: $BINARY_SIZE bytes"
        fi

    - name: Security audit (on schedule only)
      if: github.event_name == 'schedule'
      run: |
        cargo install cargo-audit --version 0.17
        cargo audit

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install cargo-llvm-cov
      run: cargo install cargo-llvm-cov

    - name: Generate coverage report
      run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: lcov.info
        fail_ci_if_error: false