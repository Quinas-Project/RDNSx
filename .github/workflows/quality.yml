name: Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check for unsafe code
      run: |
        # Count unsafe blocks/functions
        unsafe_count=$(cargo +nightly rustc -- -Z unstable-options --pretty=expanded src/main.rs 2>/dev/null | grep -c "unsafe" || echo "0")
        if [ "$unsafe_count" -gt 0 ]; then
          echo "Found $unsafe_count unsafe blocks in the codebase"
          exit 1
        else
          echo "âœ… No unsafe code blocks found"
        fi

    - name: Check documentation
      run: cargo doc --no-deps --document-private-items

    - name: Run all tests with coverage info
      run: cargo test --verbose -- --nocapture

    - name: Check minimum Rust version compatibility
      run: |
        # Test with MSRV (minimum supported Rust version)
        rustup install 1.70.0
        rustup target add x86_64-unknown-linux-gnu --toolchain 1.70.0
        cargo +1.70.0 check

    - name: Verify workspace structure
      run: |
        # Check that all expected binaries exist
        cargo build --release --bin rdnsx
        ls -la target/release/rdnsx
        ./target/release/rdnsx --version

    - name: Performance regression check
      run: |
        # Basic performance sanity check
        timeout 30s ./target/release/rdnsx query example.com --a --silent --timeout 5 || echo "Query timed out (expected for CI)"