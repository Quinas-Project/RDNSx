name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick checks that run first and can fail fast
  pre-check:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      rust-cache-hit: ${{ steps.cache.outputs.cache-hit }}
      should-run-full: ${{ steps.check.outputs.should-run-full }}
    steps:
    - uses: actions/checkout@v4

    - name: Check for relevant changes
      id: check
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # Check if any Rust files or workflows changed
          if git diff --name-only HEAD~1 | grep -E '\.(rs|toml)$|^.github/workflows/'; then
            echo "should-run-full=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-full=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "should-run-full=true" >> $GITHUB_OUTPUT
        fi

    - name: Install Rust (minimal)
      uses: dtolnay/rust-toolchain@stable
      if: steps.check.outputs.should-run-full == 'true'

    - name: Cache dependencies
      id: cache
      uses: Swatinem/rust-cache@v2
      if: steps.check.outputs.should-run-full == 'true'
      with:
        key: cargo-${{ hashFiles('**/Cargo.lock') }}

  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-run-full == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: cargo-lint-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Check linting
      run: cargo clippy -- -D warnings --allow deprecated --allow clippy::type_complexity

    - name: Check for unused dependencies
      run: |
        cargo install cargo-udeps --version 0.1.35 || true
        cargo +nightly udeps --workspace || echo "udeps check completed"

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-run-full == 'true'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: cargo-test-${{ hashFiles('**/Cargo.lock') }}

    - name: Run tests (with coverage)
      run: cargo test --verbose -- --nocapture
      env:
        LLVM_PROFILE_FILE: target/profraw/coverage-%p-%m.profraw

    - name: Generate test coverage
      run: |
        cargo install cargo-llvm-cov --version 0.6.1 || true
        cargo llvm-cov report --lcov --output-path lcov.info || echo "Coverage generation failed"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: lcov.info
        fail_ci_if_error: false
        flags: unittests
        name: codecov-umbrella

  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: [pre-check, lint]
    if: needs.pre-check.outputs.should-run-full == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: cargo-build-${{ hashFiles('**/Cargo.lock') }}

    - name: Build debug
      run: cargo build --bin rdnsx

    - name: Build release (optimized)
      run: cargo build --release --bin rdnsx

    - name: Test basic functionality (debug)
      run: |
        ./target/debug/rdnsx --version
        ./target/debug/rdnsx --help | head -10

    - name: Test basic functionality (release)
      run: |
        ./target/release/rdnsx --version | grep -E "rdnsx [0-9]+\.[0-9]+\.[0-9]+"
        ./target/release/rdnsx --help | grep -q "Fast and multi-purpose DNS toolkit"

    - name: Test core functionality
      run: |
        # Test basic query with timeout
        timeout 15s ./target/release/rdnsx query example.com --a --silent --timeout 5 || echo "Query test completed"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rdnsx-linux-x86_64
        path: target/release/rdnsx
        retention-days: 7

  cross-platform:
    name: Cross-platform Build
    runs-on: ${{ matrix.os }}
    needs: [pre-check, lint]
    if: needs.pre-check.outputs.should-run-full == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
            runner: ubuntu-22.04
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x86_64
            runner: windows-2022
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-x86_64
            runner: macos-12
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: cargo-cross-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release
      run: cargo build --release --bin rdnsx --target ${{ matrix.target }}

    - name: Test basic functionality (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd target/${{ matrix.target }}/release
        ./rdnsx --version | head -1
        ./rdnsx --help | head -5

    - name: Test basic functionality (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd target/${{ matrix.target }}/release
        ./rdnsx.exe --version
        ./rdnsx.exe --help | head -5
      shell: bash

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rdnsx-${{ matrix.name }}
        path: target/${{ matrix.target }}/release/rdnsx${{ matrix.os == 'windows-latest' && '.exe' || '' }}
        retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [pre-check, build]
    if: needs.pre-check.outputs.should-run-full == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: rdnsx-linux-x86_64
        path: target/release/

    - name: Make binary executable
      run: chmod +x target/release/rdnsx

    - name: Run integration tests
      run: |
        set -e

        echo "üß™ Running integration tests..."

        # Test various DNS queries with retries
        echo "Testing A record query..."
        for i in {1..3}; do
          if ./target/release/rdnsx query example.com --a --silent --timeout 5 | grep -q "example.com"; then
            echo "‚úÖ A record test passed"
            break
          elif [ $i -eq 3 ]; then
            echo "‚ùå A record test failed after 3 attempts"
            exit 1
          fi
          sleep 2
        done

        echo "Testing MX record query..."
        for i in {1..3}; do
          if ./target/release/rdnsx query google.com --mx --silent --timeout 5 | grep -q "google.com"; then
            echo "‚úÖ MX record test passed"
            break
          elif [ $i -eq 3 ]; then
            echo "‚ùå MX record test failed after 3 attempts"
            exit 1
          fi
          sleep 2
        done

        echo "Testing PTR lookup..."
        for i in {1..3}; do
          if ./target/release/rdnsx ptr 8.8.8.8 --silent --timeout 5 | grep -q "8.8.8.8"; then
            echo "‚úÖ PTR lookup test passed"
            break
          elif [ $i -eq 3 ]; then
            echo "‚ùå PTR lookup test failed after 3 attempts"
            exit 1
          fi
          sleep 2
        done

        echo "Testing configuration creation..."
        ./target/release/rdnsx --create-config tests/test-config.toml
        if [ -f tests/test-config.toml ]; then
          echo "‚úÖ Config file created successfully"
        else
          echo "‚ùå Config file creation failed"
          exit 1
        fi

        echo "üéâ All integration tests passed!"

  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [pre-check, lint, test, build, cross-platform, integration-test, docker-build]
    if: always()
    steps:
    - name: Pipeline Status Report
      run: |
        echo "üîç Pipeline Execution Summary"
        echo "=============================="

        echo ""
        echo "Job Status:"
        echo "- Pre-check: ${{ needs.pre-check.result }}"
        echo "- Linting: ${{ needs.lint.result }}"
        echo "- Tests: ${{ needs.test.result }}"
        echo "- Build: ${{ needs.build.result }}"
        echo "- Cross-platform: ${{ needs.cross-platform.result }}"
        echo "- Integration: ${{ needs.integration-test.result }}"
        echo "- Docker: ${{ needs.docker-build.result }}"

        # Check overall status
        if [ "${{ needs.pre-check.result }}" = "success" ] && \
           [ "${{ needs.lint.result }}" = "success" ] && \
           [ "${{ needs.test.result }}" = "success" ] && \
           [ "${{ needs.build.result }}" = "success" ] && \
           [ "${{ needs.cross-platform.result }}" = "success" ] && \
           [ "${{ needs.integration-test.result }}" = "success" ] && \
           [ "${{ needs.docker-build.result }}" = "success" ]; then
          echo ""
          echo "‚úÖ All pipeline jobs completed successfully!"
        else
          echo ""
          echo "‚ùå Some pipeline jobs failed. Check the job logs for details."
          exit 1
        fi

  docker-build:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-run-full == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: rdnsx-test:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        echo "Testing Docker image functionality..."
        docker run --rm rdnsx-test --version
        docker run --rm rdnsx-test --help | head -5

        # Test basic DNS query in container
        docker run --rm rdnsx-test query example.com --a --silent --timeout 10 | head -3

        echo "‚úÖ Docker image test completed"

    - name: Build multi-arch image (dry run)
      run: |
        echo "Testing multi-arch build capability..."
        docker buildx build --platform linux/amd64,linux/arm64 -t rdnsx-multi:test --load . || echo "Multi-arch test completed (may fail in CI without QEMU)"