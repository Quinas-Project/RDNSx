name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Check linting
      run: cargo clippy -- -D warnings --allow deprecated

    - name: Run tests
      run: cargo test --verbose

    - name: Build release
      run: cargo build --release --bin rdnsx

    - name: Test basic functionality
      run: |
        ./target/release/rdnsx --version
        ./target/release/rdnsx --help | head -10

    - name: Test core functionality
      run: |
        # Test version output
        ./target/release/rdnsx --version | grep -E "rdnsx [0-9]+\.[0-9]+\.[0-9]+"

        # Test help output
        ./target/release/rdnsx --help | grep -q "Fast and multi-purpose DNS toolkit"

        # Test basic query (with timeout to avoid hanging)
        timeout 10s ./target/release/rdnsx query example.com --a --silent --timeout 3 || echo "Query test completed"

  cross-platform:
    name: Cross-platform Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Build release
      run: cargo build --release --bin rdnsx --target ${{ matrix.target }}

    - name: Test basic functionality (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd target/${{ matrix.target }}/release
        ./rdnsx --version | head -1
        ./rdnsx --help | head -5

    - name: Test basic functionality (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd target/${{ matrix.target }}/release
        ./rdnsx.exe --version
        ./rdnsx.exe --help | head -5
      shell: bash

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Build for testing
      run: cargo build --release --bin rdnsx

    - name: Run integration tests
      run: |
        # Test various DNS queries
        echo "Testing A record query..."
        ./target/release/rdnsx query example.com --a --silent --timeout 5 | grep -q "example.com"

        echo "Testing MX record query..."
        ./target/release/rdnsx query google.com --mx --silent --timeout 5 | grep -q "google.com"

        echo "Testing PTR lookup..."
        ./target/release/rdnsx ptr 8.8.8.8 --silent --timeout 5 | grep -q "8.8.8.8"

        echo "Testing configuration creation..."
        ./target/release/rdnsx --create-config test-config.toml
        [ -f test-config.toml ] && echo "Config file created successfully"

        echo "All integration tests passed! âœ…"

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t rdnsx-test .

    - name: Test Docker image
      run: |
        docker run --rm rdnsx-test --version
        docker run --rm rdnsx-test --help | head -5